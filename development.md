# Development Notes

## Grammar Improvements

These imprpovements are comprised of a number of changes focused on the `.flex` and `.bnf` grammar files which lead to
 generated lexer and parser.

### Changelog

* lexer and parser can be generated by gradle with `gradle genLexer genParser`
* correct interpretation of labels and macros with numerals or substrings matching a mnemonic
* boolean literals are distinguished from number literals
* `null` literals 
* multilabels are interpreted correctly - including multiple `+` or `-` designations
* preprocessor imports
* distinguishes deprecated directives
* `.cpu` instruction set directive
* `.encoding` directive
* definition directives (e.g. `.byte`, `.text`, `.word`)
* infix operators
* bracketed expressions
* scoped labels
* log4j logging during test execution
* parsing test suite
* operator categories (prefix, infix, postfix)
* negative number values (prefix `-`)
* mnemonic arity: 0, 1 or 2 arguments
* `.for` loops
* `.if` ... `else` 
* addressing mode directives that belong only on mnemonic suffix
* `.fill`, `.watch` and `.while`
* semicolon as statement terminator
* scopes are blocks - labels in scopes are sufficient
* grammar: `@` string-literal prefix and string escape sequences
* `.align`, `.importonce`, `#importonce`, `.eval`, `.error`
* no-parentheses invocations
* proper handling of negative numbers
* `.errorif`, `.memblock`
* `.assert`, `.plugin` and `.filenamespace`
* functions
* segments
* parameter maps for directives
* automated negative tests
* `.modify`, `.namespace`, `.disk`, `.define`, `.filemodify`
* removed ambiguity between scoped labels and mnemonic suffixes
* scoped macro and label refs
* ternary operator (_logical-expression_ `?` _true-value-expression_ `:` _false-value-expression_)
* scopes with the same name as a mnemonic
* various semicolon statement terminator cases
* variables with directive names (strangely kick is fine with variables called `var` etc.)
* return statements
* chained method invocations like this: `picture.getHeight().sqrt().toString().length()`
* user-defined data structures http://www.theweb.dk/KickAssembler/webhelp/content/cpt_DataStructures.html
* explicit parsing of indirect addressing mode and precedence of this above grouping parentheses
* preprocessor logical expression subset
* char literals including escape chars
* namespace escaping with `@` prefix
* hex value interpolations for escape strings like this: `@"this is escaped:\$ff`


## TODO:

### Parser Features
* grammar: addressing modes - we can detect legal addressing modes
* grammar: pseudo commands 
* scopes for labels can have subscripts as per section 9.8 of manual @v5.16 e.g. `sta loop2[i].color+1`
* PSI test suite - assertions about the parse tree
    * macro definition with no braces
    * complete coverage of operator precedence     
    * get more sample code for kickassembler using 
    [this search](https://github.com/search?q=BasicUpstart2%28+extension%3A.asm&type=Code)
    * prefix logical negation operator has precedence over infix/postfix arithmetic operators
    * semicolons can terminate labels, statements or blocks (seemingly anything)
* kick parity: the following feel like maybe problems in kick    
    * invalid macro invocation syntax: space between macro name and open paren
    * grammar: ":"-prefixed labels - the prefix is optional and not part of the label name (probably for all
* clean up `KickAssembler.flex` to remove duplication (how?)
* grammar: uppercase mnemonics - kick doesn't support. maybe we should parse them and offer fix?
identifiers)

### Testing and Development Features

* generally, all features of sublime plugin (anectodally identified as "best")
* Set up a jig to automatically verify which versions of KickAss.jar a given project 
can build with (as a way of locating suitable test source) see also parsing asmInfo
* investigate invocation of kick main class directly in jvm
* Hot reload of the plugin

### Other Plugin Features

* make parser for asmInfo output!
* Memory usage graph
* update KickAssemblerSyntaxHighlighter to define more styles for language and then add text
attributes for "Default" and "Darcula" bundled schemes with additionalTextAttributes 
extension as per 
[color scheme management](https://jetbrains.org/intellij/sdk/docs/reference_guide/color_scheme_management.html)
* insights: undefined symbols
* insights: missing include files
* insights: byte and cycle count info (UI must be good and not annoying like vscode)
* Migrate assembler invocation to Build and VICE/C64 Debugger as Run targets
* Debugger integration with source maps etc.

### 6502 optimisations and fixes

* `ora <arg>` instead of `clc; adc <arg>` under certain circumstances
* https://wiki.nesdev.com/w/index.php/6502_assembly_optimisations
* https://codebase64.org/doku.php?id=base:advanced_optimizing

### Long term ideas

* Sprite, Char, Tile & Map Editor
* Other Assemblers
* Plush support for system targets other than C64 (PET, VIC20 etc.) - these might just be doable in Kick libraries
* Other CPUs (6809, Z80) 
* Macro synthesis
* Code duplication detection

## lessons learned

* preprocessor directives are executed complete before macro definitions or function 
definitions can be established. This means macros cannot expand to #import files etc. An 
`#import` in a `.macro` definition inlines the file as macro body.
* macros cannot be invoked as arguments in other macro calls 
* macro bodies must contain a sequence of valid assembly instructions or invocations, 
so they cannot provide an expansion to an instruction argument like a memory address.  

# Related Tools 

## Editors and IDEs 

* [Sublime](https://www.sublimetext.com/) supports KA though adding a _package_ called 
[Kick Assembler (C64)](https://sublime.wbond.net/packages/Kick%20Assembler%20%28C64%29) 
this is part of the recommended toolchain of the legendary 
[Shallan](https://www.youtube.com/c/Shallan64/videos). Supports syntax highlighting
and various launch configurations for VICE and C64 Debugger. See: 
https://goatpower.org/projects-releases/sublime-package-kick-assembler-c64/
* [VSCode](https://code.visualstudio.com/) is Microsoft's modern development environment 
with quite good KA support via [this extension](https://github.com/sanmont/vscode-kickass-studio) 
which claims watchpoint setting, contextual help, error evaluation, reference and definition
search and navigation. 
* [VIM](https://www.vim.org/) the mighty and ancient editor of unix past and present supports
syntax highlighting for KA with [this syntax file](https://bitbucket.org/gryf/kickass-syntax-vim/) 
from [gryf](https://bitbucket.org/gryf/) 
* [Relaunch64](http://www.popelganda.de/relaunch64.html) is a dedicated retrocoding IDE that 
supports several assemblers including KA

## Other Assemblers

The following seem to be popular alternatives to Kick Assembler:

* ACME https://sourceforge.net/projects/acme-crossass/
* 64tass https://sourceforge.net/projects/tass64/  
* CBM Prg Studio https://www.ajordison.co.uk/
* xa65 http://www.floodgap.com/retrotech/xa/
* dasm https://dasm-assembler.github.io/

Also worth noting is https://lvllvl.com/ which is a full online development and runtime environment.
