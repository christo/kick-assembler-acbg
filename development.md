# Development Notes

## Grammar Improvements

* lexer and parser can be generated by gradle

* correct interpretation of labels and macros with numerals or substrings matching a mnemonic
* boolean literals are distinguished from number literals
* null literals 
* multilabels are interpreted correctly - including multiple + or - designations
* preprocessor imports are recognised
* distinguishes deprecated directives
* added some missing directives

* `.cpu` instruction set directive
* `.encoding` directive
* definition directives (e.g. `.byte`, `.text`, `.word`)
* infix operators
* bracketed expressions
* scoped labels
* fixed logging during test execution
* added basic parsing tests

* operators (prefix, infix, postfix)
* negative number values
* mnemonic arity: 0, 1 or 2 arguments
* for loops

* if else 
* addressing mode directives that belong only on mnemonic suffix
* fill
* watch
* while
* semicolon statement terminator
* more cases for label definitions
* more test coverage for previously supported grammar elements

* scopes are blocks - labels in scopes are sufficient

* grammar: @ string-literal prefix and string escape sequences

## TODO:


* ternary operator ( ? : )
* segments
* named attribute lists for certain directives
* scopes for labels can have subscripts as per section 9.8 of manual @v5.16 e.g. `sta loop2[i].color+1`
* PSI test suite - assertions about the parse tree
    * macro definition with no braces
    * ambiguity between scoped labels and mnemonic suffixes
    * ? scopes equal to mnemonic names     
    * scope definitions
    * scoped macro and label refs
    * functions
    * get more sample code for kickassembler using 
    [this search](https://github.com/search?q=BasicUpstart2%28+extension%3A.asm&type=Code)
    * prefix logical negation operator has precedence over infix/postfix arithmetic operators
    * semicolons can terminate labels, statements or blocks (seemingly anything)
* kick parity: the following feel like maybe problems in kick    
    * invalid macro invocation syntax: space between macro name and open paren
    * kick produces a weird error for this logical expression: `! x++ > 3`
    * `"" + 1 + " string"` is ok but `1 + " string"` fails to type cast string to float (this is common in dynamic
     languages)
* decide whether to treat library functions like BasicUpstart2 specially - maybe they're just 
macro invocations? Note that the asmInfo output dumps all loaded built-in library functions and macros
* make parser for asmInfo output!
* investigate invocation of kick main class directly in jvm
* update KickAssemblerSyntaxHighlighter to define more styles for language and then add text
attributes for "Default" and "Darcula" bundled schemes with additionalTextAttributes 
extension as per 
[color scheme management](https://jetbrains.org/intellij/sdk/docs/reference_guide/color_scheme_management.html)
* grammar: uppercase mnemonics - kick doesn't support. maybe we should parse them and offer fix?
* grammar: "@"-prefixed labels - the prefix is optional and not part of the label name (probably for all
identifiers)
* grammar: addressing modes - we can detect legal addressing modes
* grammar: distinguishing functions and macros
* grammar: pseudo commands 
* insights: undefined symbols
* insights: missing include files
* insights: byte and cycle count info (UI must be good and not annoying like vscode)
* generally, all features of sublime plugin (anectodally identified as "best")
* Set up a jig to automatically verify which versions of KickAss.jar a given project 
can build with (as a way of locating suitable test source) see also parsing asmInfo


## open questions

* how to parse pseudocommand calls?
* can a function call a macro which calls a function?
* how static is the type system? Boolean expressions are required in for loop but
surely it needs to execute the expression to know if it's not boolean

## lessons learned

* preprocessor directives are executed complete before macro definitions or function 
definitions can be established. This means macros cannot expand to #import files etc. An 
`#import` in a `.macro` definition inlines the file as macro body.
* macros cannot be invoked as arguments in other macro calls 
* macro bodies must contain a sequence of valid assembly instructions or invocations, 
so they cannot provide an expansion to an instruction argument like a memory address.  

# other environments for reference

* [Sublime](https://www.sublimetext.com/) supports KA though adding a _package_ called 
[Kick Assembler (C64)](https://sublime.wbond.net/packages/Kick%20Assembler%20%28C64%29) 
this is part of the recommended toolchain of the legendary 
[Shallan](https://www.youtube.com/c/Shallan64/videos). Supports syntax highlighting
and various launch configurations for VICE and C64 Debugger. See: 
https://goatpower.org/projects-releases/sublime-package-kick-assembler-c64/
* [VSCode](https://code.visualstudio.com/) is Microsoft's modern development environment 
with quite good KA support via [this extension](https://github.com/sanmont/vscode-kickass-studio) 
which claims watchpoint setting, contextual help, error evaluation, reference and definition
search and navigation. 
* [VIM](https://www.vim.org/) the mighty and ancient editor of unix past and present supports
syntax highlighting for KA with [this syntax file](https://bitbucket.org/gryf/kickass-syntax-vim/) 
from [gryf](https://bitbucket.org/gryf/) 
* [Relaunch64](http://www.popelganda.de/relaunch64.html) is a dedicated retrocoding IDE that 
supports several assemblers including KA
