# Development Notes

## Grammar Improvements

* lexer and parser can be generated by gradle

* correct interpretation of labels and macros with numerals or substrings matching a mnemonic
* boolean literals are distinguished from number literals
* null literals 
* multilabels are interpreted correctly - including multiple + or - designations
* preprocessor imports are recognised
* distinguishes deprecated directives
* added some missing directives

* `.cpu` instruction set directive
* `.encoding` directive
* definition directives (e.g. `.byte`, `.text`, `.word`)
* infix operators
* bracketed expressions
* scoped labels
* fixed logging during test execution
* added basic parsing tests

* operators (prefix, infix, postfix)
* negative number values
* mnemonic arity: 0, 1 or 2 arguments
* for loops

* if else 
* addressing mode directives that belong only on mnemonic suffix
* fill
* watch
* while
* semicolon statement terminator
* more cases for label definitions
* more test coverage for previously supported grammar elements

## TODO:

* ternary operator ( ? : )
* segments
* named attribute lists for certain directives
* scopes for labels can have subscripts as per section 9.8 of manual @v5.16 e.g. `sta loop2[i].color+1`
* scopes are blocks - labels in scopes are sufficient
* PSI test suite - assertions about the parse tree
    * macro definition with no braces
    * ambiguity between scoped labels and mnemonic suffixes
    * ? scopes equal to mnemonic names     
    * scope definitions
    * scoped macro and label refs
    * functions
    * get more sample code for kickassembler using 
    [this search](https://github.com/search?q=BasicUpstart2%28+extension%3A.asm&type=Code)
* decide whether to treat library functions like BasicUpstart2 specially - maybe they're just 
macro invocations?
* update KickAssemblerSyntaxHighlighter to define more styles for language and then add text
attributes for "Default" and "Darcula" bundled schemes with additionalTextAttributes 
extension as per 
[color scheme management](https://jetbrains.org/intellij/sdk/docs/reference_guide/color_scheme_management.html)
* grammar: uppercase mnemonics - kick doesn't support. maybe we should parse them and offer fix?
* grammar: @ string-literal prefix and string escape sequences
* grammar: addressing modes - we can detect legal addressing modes
* grammar: distinguishing functions and macros
* grammar: pseudo commands 
* insights: undefined symbols
* insights: missing include files
* insights: byte and cycle count info (UI must be good and not annoying like vscode)
* generally, all features of sublime plugin (anectodally identified as "best")
* download all old versions of KickAss.jar (search github) and set up a jig to 
automatically verify which versions a given project can build with (as a way of
locating suitable test source)


## open questions

* how to parse pseudocommand calls?
* can a function call a macro which calls a function?
* how static is the type system? Boolean expressions are required in for loop but
surely it needs to execute the expression to know if it's not boolean

## lessons learned

* preprocessor directives are executed complete before macro definitions or function 
definitions can be established. This means macros cannot expand to #import files etc. An 
`#import` in a `.macro` definition inlines the file as macro body.
* macros cannot be invoked as arguments in other macro calls 
* macro bodies must contain a sequence of valid assembly instructions or invocations, 
so they cannot provide an expansion to an instruction argument like a memory address.  

